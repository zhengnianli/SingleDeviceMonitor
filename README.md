# 基于STM32+ATT7022的单相用电器分析监测装置   



## 1、前言

大学期间，电子类的比赛比较重要的比赛应该就是每年暑假的省/国家级大学生电子设计竞赛吧，其中省赛是偶数年，国赛是奇数年，小编都有参加过，上一篇分享了我们团队参加2016年省赛做的循迹小车，感兴趣的朋友可移步至[基于STM32+LDC1000的循迹小车](https://zhengnianli.github.io/2019/04/02/zuo-pin-ji-yu-stm32-ldc1000-de-xun-ji-xiao-che/)



本文分享的是我们团队参加2017年国赛做的单相用电器分析监测装置，这个比赛我们团队同样也获得了省一等奖。

## 2、竞赛题目
每年的TI杯电子设计竞赛都会出好几个题，这次比赛我们选的是题目——单相用电器分析监测装置。该题题目及要求如下：

[![Zki2PP.md.png](https://s2.ax1x.com/2019/06/24/Zki2PP.md.png)](https://imgchr.com/i/Zki2PP)
[![ZkifxS.md.png](https://s2.ax1x.com/2019/06/24/ZkifxS.md.png)](https://imgchr.com/i/ZkifxS)




## 3、方案的选择及比较


### 3.1 系统框图

[![Zki5rQ.md.png](https://s2.ax1x.com/2019/06/24/Zki5rQ.md.png)](https://imgchr.com/i/Zki5rQ)


该系统有两部分组成：`主机`及`从机`。

`主机`以`STM32`为主控制器，通过SPI与`ATT7022电能采集模块`进行通信。ATT7022模块负责采集用电器的一些电源参数，如电压，电流，有功功率，无功功率等。我们判断用电器状态需要用到的参数是有功功率，经过一定的判断算法判断用电器的工作状态，然后将判断好的用电器的状态通过`ZigBee无线模块`发送给从机。


`从机`也是以一片`STM32`为主控制器，将主机发送过来的用电器的工作状态发送至串口屏上进行显示。



我们采用主从结构的原因是因为题目的发挥部分有要求：

[![ZkiLGV.md.png](https://s2.ax1x.com/2019/06/24/ZkiLGV.md.png)](https://imgchr.com/i/ZkiLGV)




### 3.2 电能计量芯片的选择

`【1】`电能信息采集模块主要是由电能采集芯片 `ATT7022`、`电压互感器`、`电流互感器`三部分组成。主要负责采集电压、电流数据，并转化为功率、电能信息，将用电信息存储于 ATT7022 的寄存器。

`【2】`该芯片即可用于三相交流电的采集也可用于单相交流电的采集， ATT7022E 集成了 7 路 Sigma-delta ADC、参考电压电路以及所有功率、能量、有效值、功率因数及频率测量的数字信号处理等电路，能够测量各相以及合相的有功功率、无功功率、视在功率、有功能量及无功能量，同时还能测量各相电流、电压有效值、功率因数、相角、频率等参数，充分满足单相用电器监测装置的需求。

`【3】`在输入 220V 交流电压经 6 个 22k 电阻进行分压，经电压互感器后接的精密检流电阻接入 ATT7022E 检测引脚，输入电流经电流互感器进行 1000： 1 分流经检流电阻接入 ATT7022E 的检流引脚。电压互感器和电流互感器将高电压进行隔离，很好的起到保护作用。 ATT7022E 模块由外部晶振及基本的外围配置电阻电容组成最小系统。



### 3.3 用电器状态判断

`【1】`题意的要求电器的电流范围为`0.005A-10.0A`通过公式P=UI计算知，我们选择电器的功率范围`1.1-2200W`。

`【2】`对于可识别的工作电器总数不低于7，且电流小于5mA的大于5件，我们通过ATT7022电能芯片采集并传输得到各个用电器的工作状态。

`【3】`我们将收到的电器参数通过Zigbee传输显示在液晶界面（time<=2s）。

`【4】`第四点也是我们重点实现的步骤，由于需要实时指示当前用电器的情况，我们通过单片机读回的总功率去匹配不同用电器使用的功率和从而得出结果。通过对比了罗列法，穷举法，以及二进制模拟法：

（1）罗列法的实现太过于复杂，需将所有组合罗列并放在一个数组里面，太耗时间，太过繁琐。

（2）穷举法，通过算法能够快速得到我们所需要的结果，但是在相同功率不同用电器使用数的情况下，它并不能反应出我们实际的电器使用数。

（3）二进制模拟法，通过该方法我们将用电器的打开，关闭，分别对应二进制的0与1。通过C语言for循环遍历数组，从而得出我们预期的结果。如图所示我们通过二进制模拟，可以很清楚的看到用电器状态。

[![ZkFudA.md.png](https://s2.ax1x.com/2019/06/24/ZkFudA.md.png)](https://imgchr.com/i/ZkFudA)





### 3.4 主、从机之间的通信

主从机之间通过ZigBee无线模块进行通信，ZigBee模块与主控之间通过串口连接。主机通过ZigBee模块往从机发送特定格式的字符串数据，从机使用中断的方式进行接收数据，然后在后台解析数据并刷新数据至串口屏上。

**主机发送数据**：

[![ZkFQit.md.png](https://s2.ax1x.com/2019/06/24/ZkFQit.md.png)](https://imgchr.com/i/ZkFQit)



**从机接收数据**：

[![ZkF3z8.md.png](https://s2.ax1x.com/2019/06/24/ZkF3z8.md.png)](https://imgchr.com/i/ZkF3z8)


**从机解析并显示数据**：

[![ZkFwiq.md.png](https://s2.ax1x.com/2019/06/24/ZkFwiq.md.png)](https://imgchr.com/i/ZkFwiq)


## 4、实物图

[![ZkF2w9.md.png](https://s2.ax1x.com/2019/06/24/ZkF2w9.md.png)](https://imgchr.com/i/ZkF2w9)


这是我们的屏幕界面，用的是串口屏，串口屏我们用得很多，因为很方便地进行显示，而且显示效果也比较好。我的毕业设计也是用串口屏来显示的，有兴趣的朋友可移步至：[基于STM32的智能天气预报系统](https://zhengnianli.github.io/2018/11/21/zuo-pin-ji-yu-stm32-de-zhi-neng-tian-qi-yu-bao-xi-tong/)。

## 5、代码获取
>https://github.com/zhengnianli/SingleDeviceMonitor


---

我的个人博客为：https://zhengnianli.github.io

我的微信公众号为：嵌入式大杂烩

[![VcSFJJ.md.png](https://s2.ax1x.com/2019/06/11/VcSFJJ.md.png)](https://imgchr.com/i/VcSFJJ)
