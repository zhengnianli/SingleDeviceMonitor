/*******************************************************************************************************
**------------------------------------------------------------------------------------------------------
** 文件: SysTick.c 
** 版本: v1.0
**------------------------------------------------------------------------------------------------------
** 描述:
**     本文件是STM32系统定时器SysTick的相关函数
**------------------------------------------------------------------------------------------------------
********************************************************************************************************/
#include "config.h"  								
#include "SysTick.h"  

//-------------------------------------------------------------------------------
// 定义全局运行时间，单位1ms，可以用于uIP
static unsigned long  g_iRunTime = 0;

/*******************************************************************************************************
** 函数: SysTickInit, 软件定时器的初始化
**------------------------------------------------------------------------------------------------------
** 参数: 无
** 返回: 无
********************************************************************************************************/
void SysTickInit(void)
{
	unsigned char i;
	//-------------------------------------------------------------------------------
	// 清零所有的软件定时器
	for (i = 0; i < MAX_TIMER; i++)	  			// 清零所有的软件定时器
		g_dwSysTimer[i]= 0 ;

	SysTick_Config(72000000 / 1000);			// 每计数72000进入滴答定时器中断

}

/*******************************************************************************************************
** 函数: SysTick_Handler, 系统嘀嗒定时器中断服务程序。
**------------------------------------------------------------------------------------------------------
** 参数: 无
** 返回: 无
********************************************************************************************************/
void SysTick_Handler(void)
{
	unsigned char i;

	//-------------------------------------------------------------------------------
	// 各种定时间器计时
	if(wait_time)wait_time--;
	for (i = 0; i < MAX_TIMER; i++)							// 定时时间递减							
		if( g_dwSysTimer[i] ) g_dwSysTimer[i]-- ;
	//-------------------------------------------------------------------------------
	// 全局运行计数时间处理	
	if (g_iRunTime++ == 0xFFFFFFFF)							// 计数溢出清0	约50天
	{
		g_iRunTime = 0;
	}
	
	//-------------------------------------------------------------------------------
	// 按键捕获	
	ButtonProj( );
}



/*******************************************************************************************************
** 函数: SoftTmrDelayMS, ms级延迟，延迟精度为正负1ms
**------------------------------------------------------------------------------------------------------
** 参数: ms 延时时间 
** 返回: 无
********************************************************************************************************/
void SysTickDelayMS(unsigned long  n)
{
	//-------------------------------------------------------------------------------
	// 打开中断
	CPU_INT_ENABLE();  		 
	//-------------------------------------------------------------------------------
	// 根据定时时间给定时器赋值
	DelayTimer = n;
	//-------------------------------------------------------------------------------
	// 等待延时时间完成
	while (DelayTimer);		
}


/*******************************************************************************************************
** 函数: GetRunTime, 获取CPU运行时间，单位1ms
**------------------------------------------------------------------------------------------------------
** 参数: 无
** 返回: CPU运行时间，单位1ms
********************************************************************************************************/
unsigned long  GetRunTime(void)
{
	unsigned long  TunTime; 

	CPU_INT_DISABLE();								// 关中断 
	TunTime = g_iRunTime;							// 由于在Systick中断被改写，因此关中断进行保护 
	CPU_INT_ENABLE();								// 开中断 

	return TunTime;
}

/*******************************************************************************************************
** 函数: GetRand, 获得随机数
**------------------------------------------------------------------------------------------------------
** 参数: 无
** 返回: 
********************************************************************************************************/
int GetRand( )
{
	srand((unsigned int)(GetRunTime()));
	return rand();
}

/********************************************************************************************************
**                            End Of File
********************************************************************************************************/
